name: Sync Korean TV Channels

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新频道链接'

permissions:
  contents: write
  actions: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # 获取完整历史，确保所有文件都被拉取
        
    - name: Debug - Show directory structure
      run: |
        echo "=== 当前目录结构 ==="
        pwd
        echo -e "\n=== 根目录文件 ==="
        ls -la
        echo -e "\n=== .github 目录 ==="
        ls -la .github/ || echo ".github目录不存在"
        echo -e "\n=== .github/scripts 目录 ==="
        ls -la .github/scripts/ || echo ".github/scripts目录不存在"
        echo -e "\n=== 查找sync_channels.py ==="
        find . -name "sync_channels.py" -type f 2>/dev/null || echo "未找到sync_channels.py"
        echo -e "\n=== 查找Python文件 ==="
        find . -name "*.py" -type f 2>/dev/null || echo "未找到Python文件"
        
    - name: Create necessary directories if missing
      run: |
        echo "确保目录存在..."
        mkdir -p .github/scripts
        echo "目录结构:"
        tree .github/ || echo "tree命令不可用，使用ls:"
        ls -la .github/
        ls -la .github/scripts/
        
    - name: Setup Python environment
      run: |
        python3 -m pip install --upgrade pip
        pip3 install pyyaml requests
        
    - name: Create Python script if missing
      run: |
        echo "检查Python脚本..."
        if [ ! -f .github/scripts/sync_channels.py ]; then
          echo "Python脚本不存在，创建中..."
          cat > .github/scripts/sync_channels.py << 'EOF'
#!/usr/bin/env python3
"""
韩国电视频道同步脚本 - 自动创建版本
"""

print("这是一个临时的Python脚本")
print("请将完整的sync_channels.py脚本内容复制到这里")
EOF
          chmod +x .github/scripts/sync_channels.py
          echo "已创建临时脚本"
        else
          echo "Python脚本已存在"
          head -20 .github/scripts/sync_channels.py
        fi
        
    - name: Run channel sync script
      run: |
        echo "开始执行频道同步脚本..."
        cd /home/runner/work/file/file/  # 确保在正确目录
        python3 .github/scripts/sync_channels.py
        
    - name: Check for changes
      id: check-changes
      run: |
        echo "检查文件变化..."
        
        # 检查kr.m3u文件是否有变化
        if ! git diff --quiet kr.m3u; then
          echo "检测到变化"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "变化详情:"
          git diff kr.m3u
        else
          echo "没有检测到变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "提交更改..."
        
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add kr.m3u
        git commit -m "自动更新: 韩国电视频道链接 $(date '+%Y-%m-%d %H:%M:%S')"
        
        git push origin main
        
    - name: No changes to commit
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "没有检测到需要提交的更改"
        echo "可能的原因:"
        echo "1. 文件已经是最新状态"
        echo "2. 更新操作失败"
        echo "3. 所有频道信息都未变化"

  cleanup-old-runs:
    runs-on: ubuntu-latest
    needs: [sync-channels]
    if: always()
    
    steps:
    - name: Delete old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const workflowName = context.workflow;
          
          console.log(`仓库: ${owner}/${repo}`);
          console.log(`工作流: ${workflowName}`);
          
          // 获取当前工作流的所有运行记录
          const runs = await github.rest.actions.listWorkflowRunsForRepo({
            owner,
            repo,
            workflow_id: workflowName,
            status: 'completed',
            per_page: 100
          });
          
          console.log(`找到 ${runs.data.total_count} 个运行记录`);
          
          // 设置要保留的数量
          const keepCount = 3;
          
          if (runs.data.total_count <= keepCount) {
            console.log(`运行记录数量 (${runs.data.total_count}) 小于或等于保留数量 (${keepCount})，跳过清理`);
            return;
          }
          
          // 按创建时间排序（最新的在前）
          const sortedRuns = runs.data.workflow_runs.sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          );
          
          // 获取要删除的运行记录（跳过前keepCount个）
          const runsToDelete = sortedRuns.slice(keepCount);
          
          console.log(`将删除 ${runsToDelete.length} 个运行记录`);
          
          // 删除旧的运行记录
          let deletedCount = 0;
          for (const run of runsToDelete) {
            try {
              console.log(`删除运行记录 #${run.id} (创建于: ${run.created_at})`);
              await github.rest.actions.deleteWorkflowRun({
                owner,
                repo,
                run_id: run.id
              });
              console.log(`✅ 成功删除运行记录 #${run.id}`);
              deletedCount++;
            } catch (error) {
              console.log(`❌ 删除运行记录 #${run.id} 失败: ${error.message}`);
            }
          }
          
          console.log(`清理完成。删除了 ${deletedCount} 个运行记录，保留了最近的 ${keepCount} 个`);
