name: Sync Korean TV Channels

on:
  # 每天凌晨2点自动运行
  schedule:
    - cron: '0 2 * * *'
  # 支持手动触发
  workflow_dispatch:
  # 当配置或脚本文件变更时触发
  push:
    paths:
      - 'channels-config.yml'
      - 'scripts/sync_channels.py'
      - '.github/workflows/sync-channels.yml'

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # 获取完整历史记录，便于比较

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: ''

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pyyaml requests

    - name: Show current kr.m3u status
      run: |
        echo "=== 当前 kr.m3u 状态 ==="
        if [ -f kr.m3u ]; then
          echo "文件存在"
          echo "文件大小: $(wc -l < kr.m3u) 行"
          echo "最后修改时间: $(stat -c %y kr.m3u)"
          echo "前5行内容:"
          head -5 kr.m3u
        else
          echo "文件不存在"
        fi

    - name: Run channel sync script
      id: sync-script
      run: |
        echo "=== 运行同步脚本 ==="
        python scripts/sync_channels.py
        EXIT_CODE=$?
        echo "脚本退出码: $EXIT_CODE"
        echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        echo "=== 脚本执行完成 ==="
      continue-on-error: true

    - name: Show generated file details
      run: |
        echo "=== 生成的 kr.m3u 详细信息 ==="
        if [ -f kr.m3u ]; then
          echo "文件大小: $(wc -l < kr.m3u) 行"
          echo "文件内容前20行:"
          head -20 kr.m3u
          echo ""
          echo "文件内容后5行:"
          tail -5 kr.m3u
          echo ""
          echo "统计信息:"
          grep -c "^#EXTINF:" kr.m3u || echo "没有找到EXTINF行"
        else
          echo "错误: kr.m3u 文件未生成"
        fi

    - name: Compare with previous version
      run: |
        echo "=== 与上次提交比较 ==="
        if [ -f kr.m3u ]; then
          if git show HEAD:kr.m3u > /dev/null 2>&1; then
            echo "检测到上一次提交中的 kr.m3u 文件"
            if git diff --quiet HEAD kr.m3u; then
              echo "没有检测到变化 - 文件内容相同"
              echo "changes_detected=false" >> $GITHUB_ENV
            else
              echo "检测到变化 - 文件内容不同"
              echo "变化的行数:"
              git diff HEAD kr.m3u | grep -c "^[<>]" || true
              echo "changes_detected=true" >> $GITHUB_ENV
            fi
          else
            echo "这是第一次生成 kr.m3u 文件"
            echo "changes_detected=true" >> $GITHUB_ENV
          fi
        else
          echo "错误: kr.m3u 文件不存在"
          echo "changes_detected=false" >> $GITHUB_ENV
        fi

    - name: Upload kr.m3u as artifact (for debugging)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: generated-m3u
        path: kr.m3u
        retention-days: 7

    - name: Upload script logs
      if: always()
      run: |
        echo "=== 收集调试信息 ==="
        echo "工作目录: $(pwd)"
        echo "文件列表:"
        ls -la
        echo "脚本目录内容:"
        ls -la scripts/
        echo "配置文件内容:"
        if [ -f channels-config.yml ]; then
          echo "channels-config.yml 内容:"
          head -50 channels-config.yml
        else
          echo "channels-config.yml 不存在"
        fi

    - name: Commit and push changes
      if: env.changes_detected == 'true'
      run: |
        echo "=== 提交变更 ==="
        # 配置Git用户
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # 添加并提交变更
        git add kr.m3u
        git commit -m "Auto-sync: 更新韩国电视频道列表 [skip ci]"
        git push
        
        echo "变更已提交并推送"

    - name: No changes detected
      if: env.changes_detected != 'true'
      run: |
        echo "=== 跳过提交 ==="
        echo "没有检测到文件变化，跳过提交"
