name: Sync Korean TV Channels

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'channels-config.yml'
      - 'scripts/sync_channels.py'
      - '.github/workflows/sync-channels.yml'

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: ''

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pyyaml requests

    - name: Show current file info
      run: |
        echo "=== 当前文件状态 ==="
        echo "当前目录:"
        pwd
        ls -la
        
        echo "=== 当前 kr.m3u 内容预览 ==="
        if [ -f kr.m3u ]; then
          echo "文件大小: $(wc -l < kr.m3u) 行"
          echo "前5行:"
          head -5 kr.m3u
          echo ""
          echo "分组信息:"
          grep -o 'group-title="[^"]*"' kr.m3u | sort | uniq -c || echo "无分组信息"
        else
          echo "kr.m3u 不存在"
        fi

    - name: Show config content
      run: |
        echo "=== 配置文件内容 ==="
        if [ -f channels-config.yml ]; then
          cat channels-config.yml
        else
          echo "配置文件不存在"
        fi

    - name: Run sync script with debug output
      id: sync-script
      run: |
        echo "=== 运行同步脚本 ==="
        # 备份当前文件以便比较
        if [ -f kr.m3u ]; then
          cp kr.m3u kr.m3u.backup
        fi
        
        # 运行脚本并捕获详细输出
        python scripts/sync_channels.py
        
        EXIT_CODE=$?
        echo "脚本退出码: $EXIT_CODE"
        
        echo "=== 脚本输出结束 ==="
        
        # 检查新生成的文件
        if [ -f kr.m3u ]; then
          echo "新文件行数: $(wc -l < kr.m3u)"
          
          echo "=== 新文件分组信息 ==="
          if grep -q "group-title" kr.m3u; then
            echo "分组信息:"
            grep -o 'group-title="[^"]*"' kr.m3u | sort | uniq -c
          else
            echo "⚠ 警告: 新文件中未找到分组信息"
          fi
          
          # 如果有备份，比较差异
          if [ -f kr.m3u.backup ]; then
            echo "=== 文件比较 ==="
            if diff -q kr.m3u kr.m3u.backup > /dev/null; then
              echo "文件内容相同，无变化"
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "文件内容不同，检测到变化"
              echo "差异摘要:"
              diff -u kr.m3u.backup kr.m3u | head -20
              echo "changed=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "没有备份文件，视为有变化"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "✗ 脚本未生成 kr.m3u 文件"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true

    - name: Upload debug artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-files
        path: |
          kr.m3u
          kr.m3u.backup
        retention-days: 3

    - name: Commit and push changes
      if: steps.sync-script.outputs.changed == 'true'
      run: |
        echo "=== 准备提交变更 ==="
        
        # 显示变化详情
        echo "检测到的变化:"
        if [ -f kr.m3u.backup ]; then
          echo "行数变化:"
          echo "旧文件: $(wc -l < kr.m3u.backup) 行"
          echo "新文件: $(wc -l < kr.m3u) 行"
          
          echo "分组信息变化:"
          echo "旧文件分组:"
          grep -o 'group-title="[^"]*"' kr.m3u.backup 2>/dev/null | sort | uniq -c || echo "无分组"
          echo "新文件分组:"
          grep -o 'group-title="[^"]*"' kr.m3u 2>/dev/null | sort | uniq -c || echo "无分组"
        fi
        
        # 配置Git
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # 添加文件
        git add kr.m3u
        
        # 检查是否有可提交的更改
        if git diff --cached --quiet; then
          echo "没有检测到可提交的更改"
          exit 0
        fi
        
        # 提交
        git commit -m "auto-sync: update Korean TV channels [skip ci]"
        
        # 尝试推送，处理可能的冲突
        git pull --rebase origin main
        git push origin main
        
        echo "✓ 变更已提交并推送"

    - name: No changes to commit
      if: steps.sync-script.outputs.changed == 'false'
      run: |
        echo "=== 没有检测到变化 ==="
        echo "kr.m3u 文件与之前版本相同，跳过提交"
        
    - name: Workflow cleanup
      if: always()
      run: |
        echo "=== 清理临时文件 ==="
        rm -f kr.m3u.backup
