name: Sync Korean TV Channels

on:
  # 每2小时自动运行一次
  schedule:
    - cron: '0 */2 * * *'
  # 支持手动触发
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新频道链接'
  # 当配置文件变更时触发
  push:
    paths:
      - 'channels-config.yml'
      - 'scripts/sync_channels.py'

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: ''

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install pyyaml requests

    - name: Run sync script
      id: sync
      run: |
        echo "=== 开始同步韩国电视频道 ==="
        
        # 备份当前文件以便比较
        if [ -f kr.m3u ]; then
          cp kr.m3u kr.m3u.bak
          echo "备份当前m3u文件"
        fi
        
        # 运行同步脚本
        python scripts/sync_channels.py
        
        # 检查新生成的文件
        if [ -f kr.m3u ]; then
          echo "✓ 脚本执行成功，生成kr.m3u文件"
          
          # 检查分组信息
          echo "=== 分组信息统计 ==="
          if grep -q "group-title" kr.m3u; then
            GROUP_COUNT=$(grep -o 'group-title="[^"]*"' kr.m3u | sort | uniq | wc -l)
            echo "发现 $GROUP_COUNT 个分组:"
            grep -o 'group-title="[^"]*"' kr.m3u | sort | uniq -c
            
            echo "分组频道分布:"
            CHANNELS=$(grep -c "^#EXTINF:" kr.m3u)
            echo "总频道数: $CHANNELS"
          else
            echo "⚠ 警告: 生成的m3u文件中没有分组信息"
          fi
          
          # 比较文件变化
          if [ -f kr.m3u.bak ]; then
            if cmp -s kr.m3u kr.m3u.bak; then
              echo "=== 文件比较 ==="
              echo "文件内容未变化"
              echo "changed=false" >> $GITHUB_OUTPUT
            else
              echo "=== 文件比较 ==="
              echo "检测到文件变化"
              echo "changed=true" >> $GITHUB_OUTPUT
              
              # 显示简要差异
              echo "差异摘要:"
              echo "- 旧文件行数: $(wc -l < kr.m3u.bak)"
              echo "- 新文件行数: $(wc -l < kr.m3u)"
            fi
          else
            echo "没有旧文件，视为有变化"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "✗ 错误: 脚本未生成kr.m3u文件"
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Show generated m3u preview
      if: always()
      run: |
        echo "=== 生成文件预览 ==="
        if [ -f kr.m3u ]; then
          echo "文件前10行:"
          head -10 kr.m3u
          echo ""
          echo "文件后5行:"
          tail -5 kr.m3u
          echo ""
          echo "分组统计:"
          grep -o 'group-title="[^"]*"' kr.m3u 2>/dev/null | sort | uniq -c || echo "无分组信息"
        fi

    - name: Commit and push changes
      if: steps.sync.outputs.changed == 'true'
      run: |
        echo "=== 提交变更 ==="
        
        # 配置Git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # 添加文件
        git add kr.m3u
        
        # 检查是否有变更
        if git diff --cached --quiet; then
          echo "没有检测到可提交的变更"
        else
          # 提交变更
          git commit -m "auto-sync: update Korean TV channels with groups [skip ci]"
          
          # 推送
          git pull --rebase origin main
          git push origin main
          
          echo "✓ 变更已提交并推送"
        fi

    - name: No changes detected
      if: steps.sync.outputs.changed == 'false'
      run: |
        echo "=== 跳过提交 ==="
        echo "文件内容未变化，跳过提交"

    - name: Cleanup
      if: always()
      run: |
        echo "=== 清理临时文件 ==="
        rm -f kr.m3u.bak

  cleanup-workflow:
    needs: sync-channels
    runs-on: ubuntu-latest
    if: always()
    permissions:
      actions: write
    
    steps:
    - name: Cleanup old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: ${{ github.repository }}
        retain_days: 1
        keep_minimum_runs: 3
