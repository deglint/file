name: Sync MBN URI from kenpark76/koreatv.json

on:
  schedule:
    - cron: '0 * * * *'    # 每小时运行一次；按需修改
  workflow_dispatch:        # 手动触发

jobs:
  sync-mbn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: Download koreatv.json from upstream
        run: |
          UPSTREAM_RAW="https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json"
          echo "Downloading $UPSTREAM_RAW"
          curl -fsSL "$UPSTREAM_RAW" -o /tmp/koreatv.json

      - name: Extract MBN URI
        id: extract
        run: |
          MBN_URI=$(jq -r '.[] | select(.name=="MBN") | .uris[0]' /tmp/koreatv.json 2>/dev/null || true)
          if [ -z "$MBN_URI" ] || [ "$MBN_URI" = "null" ]; then
            echo "MBN URI not found or empty"
            echo "mbn_uri=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Found MBN URI"
          echo "mbn_uri=$MBN_URI" >> $GITHUB_OUTPUT

      - name: Replace MBN URL in kr.m3u (awk)
        run: |
          if [ -z "${{ steps.extract.outputs.mbn_uri }}" ]; then
            echo "No MBN URI extracted, skipping replacement"
            exit 0
          fi
          cp kr.m3u kr.m3u.bak || true
          export MBN_URI='${{ steps.extract.outputs.mbn_uri }}'
          # 用 awk 找到包含 "MBN" 的 EXTINF 行，然后将其下一行替换为新 URI
          awk -v new="$MBN_URI" 'BEGIN{found=0}
            {
              line=$0
              low=tolower(line)
              if(found==1){
                print new
                found=2
                next
              }
              if(low ~ /#extinf:[^,]*, *mbn/){
                print $0
                found=1
                next
              }
              print $0
            }
            END{
              # 如果文件以 EXTINF MBN 结尾且没有下一行，追加 new
              if(found==1) print new
            }' kr.m3u > kr.m3u.tmp && mv kr.m3u.tmp kr.m3u

          echo "Replacement step completed"

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q kr.m3u; then
            git add kr.m3u
            git commit -m "chore: sync MBN URI from kenpark76/koreatv.json"
            git push
          else
            echo "No changes to commit"
          fi
