name: Sync Korean TV Channels

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新频道链接'

permissions:
  contents: write
  actions: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Fetch KoreaTV JSON data
      run: |
        curl -s -o koreatv.json https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json
        
    - name: Fetch KoreaTV EPG XML data
      run: |
        curl -s -o koreatvEPG.xml https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatvEPG.xml
        
    - name: Extract MBN URLs
      id: extract-urls
      run: |
        # 提取MBN URL
        MBN_URL=$(jq -r '.[] | select(.name=="MBN") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        # 提取MBN 플러스 URL
        MBN_PLUS_URL=$(jq -r '.[] | select(.name=="MBN 플러스") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        echo "MBN_URL=$MBN_URL" >> $GITHUB_ENV
        echo "MBN_PLUS_URL=$MBN_PLUS_URL" >> $GITHUB_ENV
        
        echo "MBN URL: $MBN_URL"
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
    - name: Extract Channel Info for MBC M, JTBC, JTBC2
      id: extract-channel-info
      run: |
        # 提取MBC M信息
        MBCM_URL=$(jq -r '.[] | select(.name=="MBC M") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        MBCM_LOGO=$(jq -r '.[] | select(.name=="MBC M") | .logo' koreatv.json 2>/dev/null || echo "")
        
        # 提取JTBC信息
        JTBC_URL=$(jq -r '.[] | select(.name=="JTBC") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        JTBC_LOGO=$(jq -r '.[] | select(.name=="JTBC") | .logo' koreatv.json 2>/dev/null || echo "")
        
        # 提取JTBC2信息
        JTBC2_URL=$(jq -r '.[] | select(.name=="JTBC2") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        JTBC2_LOGO=$(jq -r '.[] | select(.name=="JTBC2") | .logo' koreatv.json 2>/dev/null || echo "")
        
        # 从koreatvEPG.xml提取频道ID
        if [ -f koreatvEPG.xml ]; then
          # 提取MBC M频道ID
          MBCM_CHANNEL_ID=$(grep -A 1 '<channel id=' koreatvEPG.xml | grep -B 1 'MBC M' | grep 'channel id=' | sed -n 's/.*channel id="\([^"]*\)".*/\1/p' | head -1)
          
          # 提取JTBC频道ID
          JTBC_CHANNEL_ID=$(grep -A 1 '<channel id=' koreatvEPG.xml | grep -B 1 'JTBC' | grep 'channel id=' | grep -v 'JTBC2' | sed -n 's/.*channel id="\([^"]*\)".*/\1/p' | head -1)
          
          # 提取JTBC2频道ID
          JTBC2_CHANNEL_ID=$(grep -A 1 '<channel id=' koreatvEPG.xml | grep -B 1 'JTBC2' | grep 'channel id=' | sed -n 's/.*channel id="\([^"]*\)".*/\1/p' | head -1)
        else
          MBCM_CHANNEL_ID=""
          JTBC_CHANNEL_ID=""
          JTBC2_CHANNEL_ID=""
        fi
        
        # 如果没找到，使用默认值
        if [ -z "$MBCM_CHANNEL_ID" ]; then
          echo "警告: 未在EPG中找到MBC M频道ID，使用默认值"
          MBCM_CHANNEL_ID="624.lg"
        fi
        
        if [ -z "$JTBC_CHANNEL_ID" ]; then
          echo "警告: 未在EPG中找到JTBC频道ID，使用默认值"
          JTBC_CHANNEL_ID="007.tving"
        fi
        
        if [ -z "$JTBC2_CHANNEL_ID" ]; then
          echo "警告: 未在EPG中找到JTBC2频道ID，使用默认值"
          JTBC2_CHANNEL_ID="008.tving"
        fi
        
        # 输出到环境变量
        echo "MBCM_URL=$MBCM_URL" >> $GITHUB_ENV
        echo "MBCM_LOGO=$MBCM_LOGO" >> $GITHUB_ENV
        echo "MBCM_CHANNEL_ID=$MBCM_CHANNEL_ID" >> $GITHUB_ENV
        
        echo "JTBC_URL=$JTBC_URL" >> $GITHUB_ENV
        echo "JTBC_LOGO=$JTBC_LOGO" >> $GITHUB_ENV
        echo "JTBC_CHANNEL_ID=$JTBC_CHANNEL_ID" >> $GITHUB_ENV
        
        echo "JTBC2_URL=$JTBC2_URL" >> $GITHUB_ENV
        echo "JTBC2_LOGO=$JTBC2_LOGO" >> $GITHUB_ENV
        echo "JTBC2_CHANNEL_ID=$JTBC2_CHANNEL_ID" >> $GITHUB_ENV
        
        echo "频道信息提取完成:"
        echo "MBC M: $MBCM_CHANNEL_ID, $MBCM_URL"
        echo "JTBC: $JTBC_CHANNEL_ID, $JTBC_URL"
        echo "JTBC2: $JTBC2_CHANNEL_ID, $JTBC2_URL"
        
    - name: Debug - Show kr.m3u content
      run: |
        echo "显示kr.m3u文件内容相关频道:"
        echo "=========================================="
        echo "MBN相关内容:"
        grep -A 1 -B 1 "MBN" kr.m3u || echo "未找到MBN相关内容"
        echo "=========================================="
        echo -e "\nMBC M相关内容:"
        grep -A 1 -B 1 "MBC M" kr.m3u || echo "未找到MBC M相关内容"
        echo "=========================================="
        echo -e "\nJTBC相关内容:"
        grep -A 1 -B 1 "JTBC" kr.m3u | grep -v "JTBC2" || echo "未找到JTBC相关内容"
        echo "=========================================="
        echo -e "\nJTBC2相关内容:"
        grep -A 1 -B 1 "JTBC2" kr.m3u || echo "未找到JTBC2相关内容"
        echo "=========================================="
        
    - name: Clean duplicate channels
      run: |
        echo "清理重复的频道条目..."
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk清理重复频道，每个频道只保留一个
        awk '
        function process_channel(channel_name, current_extinf, current_url) {
          if (!(channel_name in seen)) {
            # 第一次见到这个频道，输出
            print current_extinf
            print current_url
            seen[channel_name] = 1
          } else {
            # 已经见过这个频道，跳过（删除重复）
            print "# 删除重复的 " channel_name " 频道" > "/dev/stderr"
          }
        }
        
        BEGIN {
          delete seen
          current_extinf = ""
          channel_name = ""
        }
        
        {
          if ($0 ~ /^#EXTINF:/) {
            # 如果是EXTINF行，提取频道名称
            current_extinf = $0
            # 尝试提取逗号后的频道名称
            if (match($0, /,(.+)$/, arr)) {
              channel_name = arr[1]
            } else {
              channel_name = ""
            }
          } else if ($0 ~ /^https?:\/\// && current_extinf != "") {
            # 如果是URL行，并且有对应的EXTINF
            process_channel(channel_name, current_extinf, $0)
            current_extinf = ""
            channel_name = ""
          } else {
            # 其他行直接输出
            print $0
          }
        }
        ' kr.m3u.bak > kr.m3u.clean
        
        mv kr.m3u.clean kr.m3u
        echo "重复频道清理完成"
        
    - name: Update MBN channel
      if: env.MBN_URL != '' && env.MBN_URL != 'null'
      run: |
        echo "更新MBN频道链接..."
        echo "MBN URL: $MBN_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk更新MBN频道（确保只更新第一个匹配项）
        awk -v mbn_url="$MBN_URL" '
        BEGIN { updated = 0 }
        /#EXTINF.*MBN/ && !/플러스/ && !updated {
            print $0
            getline
            print mbn_url
            updated = 1
            next
        }
        {print}
        ' kr.m3u.bak > kr.m3u
        
        echo "更新后检查:"
        grep -A 1 "MBN" kr.m3u | grep -v "플러스"
        
    - name: Check if MBN 플러스 exists
      id: check-mbn-plus
      run: |
        echo "检查MBN 플러斯是否存在..."
        if grep -q "MBN 플러스" kr.m3u; then
          echo "找到MBN 플러斯频道"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "未找到MBN 플러斯频道"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update existing MBN 플러스 channel
      if: steps.check-mbn-plus.outputs.exists == 'true' && env.MBN_PLUS_URL != '' && env.MBN_PLUS_URL != 'null'
      run: |
        echo "更新现有的MBN 플러斯频道..."
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk更新MBN 플러斯频道（确保只更新第一个匹配项）
        awk -v mbn_plus_url="$MBN_PLUS_URL" '
        BEGIN { updated = 0 }
        /#EXTINF.*MBN 플러스/ && !updated {
            print $0
            getline
            print mbn_plus_url
            updated = 1
            next
        }
        {print}
        ' kr.m3u.bak > kr.m3u
        
        echo "更新后检查MBN 플러斯:"
        grep -A 1 "MBN 플러스" kr.m3u
        
    - name: Add new MBN 플러斯 channel
      if: steps.check-mbn-plus.outputs.exists == 'false' && env.MBN_PLUS_URL != '' && env.MBN_PLUS_URL != 'null'
      run: |
        echo "添加新的MBN 플러斯频道..."
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
        # 在文件末尾添加MBN 플러斯频道
        echo "" >> kr.m3u  # 确保新行
        echo "#EXTINF:-1 tvg-id=\"\" tvg-name=\"MBN 플러스\" tvg-logo=\"https://i.postimg.cc/NFxKbbvJ/mbn-plus.png\" group-title=\"韩国\",MBN 플러스" >> kr.m3u
        echo "$MBN_PLUS_URL" >> kr.m3u
        
        echo "添加后检查MBN 플러斯:"
        grep -A 1 "MBN 플러스" kr.m3u || echo "未找到MBN 플러斯"
        
    - name: Check if channels exist
      id: check-channels-exist
      run: |
        echo "检查频道是否存在..."
        
        # 检查MBC M
        if grep -q "#EXTINF.*MBC M" kr.m3u; then
          echo "找到MBC M频道"
          echo "MBCM_EXISTS=true" >> $GITHUB_ENV
        else
          echo "未找到MBC M频道"
          echo "MBCM_EXISTS=false" >> $GITHUB_ENV
        fi
        
        # 检查JTBC
        if grep -q "#EXTINF.*JTBC" kr.m3u && ! grep -q "#EXTINF.*JTBC2" kr.m3u; then
          echo "找到JTBC频道"
          echo "JTBC_EXISTS=true" >> $GITHUB_ENV
        else
          # 更精确的检查
          if grep -A 1 "#EXTINF.*JTBC" kr.m3u | grep -q "JTBC2"; then
            echo "未找到JTBC频道（只找到JTBC2）"
            echo "JTBC_EXISTS=false" >> $GITHUB_ENV
          elif grep -q "#EXTINF.*JTBC$" kr.m3u || grep -q '#EXTINF.*tvg-name="JTBC"' kr.m3u; then
            echo "找到JTBC频道"
            echo "JTBC_EXISTS=true" >> $GITHUB_ENV
          else
            echo "未找到JTBC频道"
            echo "JTBC_EXISTS=false" >> $GITHUB_ENV
          fi
        fi
        
        # 检查JTBC2
        if grep -q "#EXTINF.*JTBC2" kr.m3u; then
          echo "找到JTBC2频道"
          echo "JTBC2_EXISTS=true" >> $GITHUB_ENV
        else
          echo "未找到JTBC2频道"
          echo "JTBC2_EXISTS=false" >> $GITHUB_ENV
        fi
        
    - name: Update or add MBC M channel
      if: env.MBCM_URL != '' && env.MBCM_URL != 'null' && env.MBCM_CHANNEL_ID != '' && env.MBCM_LOGO != ''
      run: |
        echo "处理MBC M频道..."
        echo "MBC M 频道ID: $MBCM_CHANNEL_ID"
        echo "MBC M Logo: $MBCM_LOGO"
        echo "MBC M URL: $MBCM_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 检查是否已存在MBC M
        if grep -q "#EXTINF.*MBC M" kr.m3u.bak; then
          echo "MBC M已存在，进行更新..."
          # 更新现有的MBC M频道（只更新第一个匹配项）
          awk -v channel_id="$MBCM_CHANNEL_ID" -v logo="$MBCM_LOGO" -v url="$MBCM_URL" '
          BEGIN { updated = 0 }
          /#EXTINF.*MBC M/ && !updated {
              print "#EXTINF:-1 tvg-id=\"" channel_id "\" tvg-logo=\"" logo "\",MBC M"
              getline  # 跳过原有的URL行
              print url
              updated = 1
              next
          }
          {print}
          ' kr.m3u.bak > kr.m3u
        else
          echo "MBC M不存在，添加新频道..."
          # 在文件末尾添加MBC M频道
          cp kr.m3u.bak kr.m3u
          echo "" >> kr.m3u  # 确保新行
          echo "#EXTINF:-1 tvg-id=\"$MBCM_CHANNEL_ID\" tvg-logo=\"$MBCM_LOGO\",MBC M" >> kr.m3u
          echo "$MBCM_URL" >> kr.m3u
        fi
        
        echo "处理后检查MBC M:"
        grep -A 1 "MBC M" kr.m3u || echo "未找到MBC M"
        
    - name: Update or add JTBC channel
      if: env.JTBC_URL != '' && env.JTBC_URL != 'null' && env.JTBC_CHANNEL_ID != '' && env.JTBC_LOGO != ''
      run: |
        echo "处理JTBC频道..."
        echo "JTBC 频道ID: $JTBC_CHANNEL_ID"
        echo "JTBC Logo: $JTBC_LOGO"
        echo "JTBC URL: $JTBC_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 检查是否已存在JTBC（排除JTBC2）
        if grep -q "#EXTINF.*JTBC" kr.m3u.bak && ! grep -q "#EXTINF.*JTBC2" kr.m3u.bak; then
          echo "JTBC已存在，进行更新..."
          # 更新现有的JTBC频道（只更新第一个匹配项）
          awk -v channel_id="$JTBC_CHANNEL_ID" -v logo="$JTBC_LOGO" -v url="$JTBC_URL" '
          BEGIN { updated = 0 }
          /#EXTINF.*JTBC/ && !/JTBC2/ && !updated {
              print "#EXTINF:-1 tvg-id=\"" channel_id "\" tvg-logo=\"" logo "\",JTBC"
              getline  # 跳过原有的URL行
              print url
              updated = 1
              next
          }
          {print}
          ' kr.m3u.bak > kr.m3u
        else
          echo "JTBC不存在，添加新频道..."
          # 在文件末尾添加JTBC频道
          cp kr.m3u.bak kr.m3u
          echo "" >> kr.m3u  # 确保新行
          echo "#EXTINF:-1 tvg-id=\"$JTBC_CHANNEL_ID\" tvg-logo=\"$JTBC_LOGO\",JTBC" >> kr.m3u
          echo "$JTBC_URL" >> kr.m3u
        fi
        
        echo "处理后检查JTBC:"
        grep -A 1 "JTBC" kr.m3u | grep -v "JTBC2" || echo "未找到JTBC"
        
    - name: Update or add JTBC2 channel
      if: env.JTBC2_URL != '' && env.JTBC2_URL != 'null' && env.JTBC2_CHANNEL_ID != '' && env.JTBC2_LOGO != ''
      run: |
        echo "处理JTBC2频道..."
        echo "JTBC2 频道ID: $JTBC2_CHANNEL_ID"
        echo "JTBC2 Logo: $JTBC2_LOGO"
        echo "JTBC2 URL: $JTBC2_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 检查是否已存在JTBC2
        if grep -q "#EXTINF.*JTBC2" kr.m3u.bak; then
          echo "JTBC2已存在，进行更新..."
          # 更新现有的JTBC2频道（只更新第一个匹配项）
          awk -v channel_id="$JTBC2_CHANNEL_ID" -v logo="$JTBC2_LOGO" -v url="$JTBC2_URL" '
          BEGIN { updated = 0 }
          /#EXTINF.*JTBC2/ && !updated {
              print "#EXTINF:-1 tvg-id=\"" channel_id "\" tvg-logo=\"" logo "\",JTBC2"
              getline  # 跳过原有的URL行
              print url
              updated = 1
              next
          }
          {print}
          ' kr.m3u.bak > kr.m3u
        else
          echo "JTBC2不存在，添加新频道..."
          # 在文件末尾添加JTBC2频道
          cp kr.m3u.bak kr.m3u
          echo "" >> kr.m3u  # 确保新行
          echo "#EXTINF:-1 tvg-id=\"$JTBC2_CHANNEL_ID\" tvg-logo=\"$JTBC2_LOGO\",JTBC2" >> kr.m3u
          echo "$JTBC2_URL" >> kr.m3u
        fi
        
        echo "处理后检查JTBC2:"
        grep -A 1 "JTBC2" kr.m3u || echo "未找到JTBC2"
        
    - name: Final check and remove duplicates
      run: |
        echo "最终检查和清理重复频道..."
        
        # 备份文件
        cp kr.m3u kr.m3u.bak
        
        # 最终清理：确保每个频道只出现一次
        awk '
        function process_channel(channel_name, current_extinf, current_url) {
          if (!(channel_name in seen)) {
            # 第一次见到这个频道，输出
            print current_extinf
            print current_url
            seen[channel_name] = 1
          } else {
            # 已经见过这个频道，跳过（删除重复）
            print "# 删除重复的 " channel_name " 频道" > "/dev/stderr"
          }
        }
        
        BEGIN {
          delete seen
          current_extinf = ""
          channel_name = ""
        }
        
        {
          if ($0 ~ /^#EXTINF:/) {
            # 如果是EXTINF行，提取频道名称
            current_extinf = $0
            # 尝试提取逗号后的频道名称
            if (match($0, /,(.+)$/, arr)) {
              channel_name = arr[1]
            } else {
              channel_name = ""
            }
          } else if ($0 ~ /^https?:\/\// && current_extinf != "") {
            # 如果是URL行，并且有对应的EXTINF
            process_channel(channel_name, current_extinf, $0)
            current_extinf = ""
            channel_name = ""
          } else {
            # 其他行直接输出
            print $0
          }
        }
        
        END {
          # 如果有未处理的EXTINF（不应该发生）
          if (current_extinf != "") {
            print current_extinf
          }
        }
        ' kr.m3u.bak > kr.m3u.clean
        
        mv kr.m3u.clean kr.m3u
        
        echo "最终检查结果:"
        echo "MBN:"
        grep -c "#EXTINF.*MBN" kr.m3u | xargs echo "  数量: "
        echo "MBC M:"
        grep -c "#EXTINF.*MBC M" kr.m3u | xargs echo "  数量: "
        echo "JTBC:"
        grep -c "#EXTINF.*JTBC" kr.m3u | grep -v "JTBC2" | xargs echo "  数量: "
        echo "JTBC2:"
        grep -c "#EXTINF.*JTBC2" kr.m3u | xargs echo "  数量: "
        
    - name: Check for changes
      id: check-changes
      run: |
        echo "检查文件变化..."
        
        # 检查kr.m3u文件是否有变化
        if ! git diff --quiet kr.m3u; then
          echo "检测到变化"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "变化详情:"
          git diff kr.m3u
        else
          echo "没有检测到变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "提交更改..."
        
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add kr.m3u
        git commit -m "自动更新: MBN, MBC M, JTBC, JTBC2频道链接 $(date '+%Y-%m-%d %H:%M:%S')"
        
        git push origin main
        
    - name: No changes to commit
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "没有检测到需要提交的更改"
        echo "可能的原因:"
        echo "1. 文件已经是最新状态"
        echo "2. 更新操作失败"
        echo "3. 匹配模式不正确"
        echo ""
        echo "当前URL:"
        echo "MBN URL: ${{ env.MBN_URL }}"
        echo "MBN 플러斯 URL: ${{ env.MBN_PLUS_URL }}"
        echo "MBC M 频道ID: ${{ env.MBCM_CHANNEL_ID }}, URL: ${{ env.MBCM_URL }}"
        echo "JTBC 频道ID: ${{ env.JTBC_CHANNEL_ID }}, URL: ${{ env.JTBC_URL }}"
        echo "JTBC2 频道ID: ${{ env.JTBC2_CHANNEL_ID }}, URL: ${{ env.JTBC2_URL }}"
        echo ""
        echo "文件当前状态:"
        echo "MBN:"
        grep -A 1 "MBN" kr.m3u | grep -v "플러스" || echo "未找到MBN"
        echo ""
        echo "MBC M:"
        grep -A 1 "MBC M" kr.m3u || echo "未找到MBC M"
        echo ""
        echo "JTBC:"
        grep -A 1 "JTBC" kr.m3u | grep -v "JTBC2" || echo "未找到JTBC"
        echo ""
        echo "JTBC2:"
        grep -A 1 "JTBC2" kr.m3u || echo "未找到JTBC2"

  # 清理旧的工作流运行
  cleanup-old-runs:
    runs-on: ubuntu-latest
    needs: [sync-channels]
    if: always()
    
    steps:
    - name: Delete old workflow runs
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const workflowName = context.workflow;
          
          console.log(`仓库: ${owner}/${repo}`);
          console.log(`工作流: ${workflowName}`);
          
          // 获取当前工作流的所有运行记录
          const runs = await github.rest.actions.listWorkflowRunsForRepo({
            owner,
            repo,
            workflow_id: workflowName,
            status: 'completed',
            per_page: 100
          });
          
          console.log(`找到 ${runs.data.total_count} 个运行记录`);
          
          // 设置要保留的数量
          const keepCount = 3;
          
          if (runs.data.total_count <= keepCount) {
            console.log(`运行记录数量 (${runs.data.total_count}) 小于或等于保留数量 (${keepCount})，跳过清理`);
            return;
          }
          
          // 按创建时间排序（最新的在前）
          const sortedRuns = runs.data.workflow_runs.sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          );
          
          // 获取要删除的运行记录（跳过前keepCount个）
          const runsToDelete = sortedRuns.slice(keepCount);
          
          console.log(`将删除 ${runsToDelete.length} 个运行记录`);
          
          // 删除旧的运行记录
          let deletedCount = 0;
          for (const run of runsToDelete) {
            try {
              console.log(`删除运行记录 #${run.id} (创建于: ${run.created_at})`);
              await github.rest.actions.deleteWorkflowRun({
                owner,
                repo,
                run_id: run.id
              });
              console.log(`✅ 成功删除运行记录 #${run.id}`);
              deletedCount++;
            } catch (error) {
              console.log(`❌ 删除运行记录 #${run.id} 失败: ${error.message}`);
            }
          }
          
          console.log(`清理完成。删除了 ${deletedCount} 个运行记录，保留了最近的 ${keepCount} 个`);
