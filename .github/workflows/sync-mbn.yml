# .github/workflows/sync-mbn.yml
name: Sync MBN URI from kenpark76/koreatv.json

on:
  schedule:
    - cron: '0 * * * *'    # 每小时运行一次；按需修改
  workflow_dispatch:        # 手动触发

jobs:
  sync-mbn:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Ensure deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl python3

      - name: Download koreatv.json from upstream
        run: |
          UPSTREAM_RAW="https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json"
          echo "Downloading $UPSTREAM_RAW"
          curl -fsSL "$UPSTREAM_RAW" -o /tmp/koreatv.json

      - name: Extract MBN URI
        id: extract
        run: |
          MBN_URI=$(jq -r '.[] | select(.name=="MBN") | .uris[0]' /tmp/koreatv.json 2>/dev/null || true)
          if [ -z "$MBN_URI" ] || [ "$MBN_URI" = "null" ]; then
            echo "MBN URI not found or empty"
            echo "mbn_uri=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Found MBN URI"
          echo "mbn_uri=$MBN_URI" >> $GITHUB_OUTPUT

      - name: Replace MBN URL in kr.m3u
        run: |
          if [ -z "${{ steps.extract.outputs.mbn_uri }}" ]; then
            echo "No MBN URI extracted, skipping replacement"
            exit 0
          fi
          cp kr.m3u kr.m3u.bak || true
          export MBN_URI='${{ steps.extract.outputs.mbn_uri }}'
          python3 - << 'PY'
import re, os, sys
mbn_uri = os.environ.get('MBN_URI','')
if not mbn_uri:
    print('MBN_URI empty, nothing to do')
    raise SystemExit(0)

# Replace the stream URL that immediately follows the EXTINF line for MBN
pattern = re.compile(r"(#EXTINF:[^\n]*,\s*MBN\s*\n)(?:.+)", re.IGNORECASE)
text = open('kr.m3u', 'r', encoding='utf-8').read()
new = pattern.sub(lambda m: m.group(1) + mbn_uri, text, count=1)
if new == text:
    # fallback variant without space before MBN
    pattern2 = re.compile(r"(#EXTINF:[^\n]*,MBN\s*\n)(?:.+)", re.IGNORECASE)
    new = pattern2.sub(lambda m: m.group(1) + mbn_uri, text, count=1)

if new == text:
    print('No replacement performed; pattern not found. kr.m3u unchanged.')
else:
    open('kr.m3u', 'w', encoding='utf-8').write(new)
    print('MBN URL replaced with:', mbn_uri)
PY

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q kr.m3u; then
            git add kr.m3u
            git commit -m "chore: sync MBN URI from kenpark76/koreatv.json"
            git push
          else
            echo "No changes to commit"
          fi
