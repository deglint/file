name: Sync MBN Channels

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新MBN频道'

permissions:
  contents: write
  actions: write

jobs:
  sync-mbn-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Fetch KoreaTV JSON data
      run: |
        curl -s -o koreatv.json https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json
        
    - name: Extract MBN URLs
      id: extract-urls
      run: |
        # 提取MBN URL
        MBN_URL=$(jq -r '.[] | select(.name=="MBN") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        # 提取MBN 플러스 URL
        MBN_PLUS_URL=$(jq -r '.[] | select(.name=="MBN 플러스") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        echo "MBN_URL=$MBN_URL" >> $GITHUB_ENV
        echo "MBN_PLUS_URL=$MBN_PLUS_URL" >> $GITHUB_ENV
        
        echo "MBN URL: $MBN_URL"
        echo "MBN 플러스 URL: $MBN_PLUS_URL"
        
    - name: Debug - Show kr.m3u content
      run: |
        echo "显示kr.m3u文件内容:"
        echo "=========================================="
        grep -A 1 -B 1 "MBN" kr.m3u || echo "未找到MBN相关内容"
        echo "=========================================="
        echo -e "\n显示文件前20行:"
        head -20 kr.m3u
        
    - name: Update MBN channel
      if: env.MBN_URL != '' && env.MBN_URL != 'null'
      run: |
        echo "更新MBN频道链接..."
        echo "MBN URL: $MBN_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk更新MBN频道
        awk -v mbn_url="$MBN_URL" '
        /#EXTINF.*MBN/ && !/플러스/ {
            print $0
            getline
            print mbn_url
            next
        }
        {print}
        ' kr.m3u.bak > kr.m3u
        
        echo "更新后检查:"
        grep -A 1 "MBN" kr.m3u | grep -v "플러스"
        
    - name: Check if MBN 플러스 exists
      id: check-mbn-plus
      run: |
        echo "检查MBN 플러斯是否存在..."
        if grep -q "MBN 플러스" kr.m3u; then
          echo "找到MBN 플러斯频道"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "未找到MBN 플러斯频道"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update existing MBN 플러스 channel
      if: steps.check-mbn-plus.outputs.exists == 'true' && env.MBN_PLUS_URL != '' && env.MBN_PLUS_URL != 'null'
      run: |
        echo "更新现有的MBN 플러斯频道..."
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk更新MBN 플러斯频道
        awk -v mbn_plus_url="$MBN_PLUS_URL" '
        /#EXTINF.*MBN 플러스/ {
            print $0
            getline
            print mbn_plus_url
            next
        }
        {print}
        ' kr.m3u.bak > kr.m3u
        
        echo "更新后检查MBN 플러斯:"
        grep -A 1 "MBN 플러스" kr.m3u
        
    - name: Add new MBN 플러斯 channel
      if: steps.check-mbn-plus.outputs.exists == 'false' && env.MBN_PLUS_URL != '' && env.MBN_PLUS_URL != 'null'
      run: |
        echo "添加新的MBN 플러斯频道..."
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
        # 备份原始文件
        cp kr.m3u kr.m3u.bak
        
        # 使用awk添加MBN 플러斯频道
        awk -v mbn_plus_url="$MBN_PLUS_URL" '
        /#EXTINF.*MBN/ && !/플러스/ {
            print $0
            getline
            print $0
            print "#EXTINF:-1 tvg-id=\"\" tvg-name=\"MBN 플러스\" tvg-logo=\"https://i.postimg.cc/NFxKbbvJ/mbn-plus.png\" group-title=\"韩国\",MBN 플러스"
            print mbn_plus_url
            next
        }
        {print}
        ' kr.m3u.bak > kr.m3u
        
        echo "添加后检查MBN 플러斯:"
        grep -A 1 "MBN 플러스" kr.m3u || echo "未找到MBN 플러斯"
        
    - name: Check for changes
      id: check-changes
      run: |
        echo "检查文件变化..."
        
        # 检查kr.m3u文件是否有变化
        if ! git diff --quiet kr.m3u; then
          echo "检测到变化"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "变化详情:"
          git diff kr.m3u
        else
          echo "没有检测到变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "提交更改..."
        
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add kr.m3u
        git commit -m "自动更新: MBN和MBN 플러斯频道链接 $(date '+%Y-%m-%d %H:%M:%S')"
        
        git push origin main
        
    - name: No changes to commit
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "没有检测到需要提交的更改"
        echo "可能的原因:"
        echo "1. 文件已经是最新状态"
        echo "2. 更新操作失败"
        echo "3. 匹配模式不正确"
        echo ""
        echo "当前URL:"
        echo "MBN URL: ${{ env.MBN_URL }}"
        echo "MBN 플러斯 URL: ${{ env.MBN_PLUS_URL }}"
        echo ""
        echo "文件当前状态:"
        grep -A 1 "MBN" kr.m3u

  cleanup-old-runs:
    runs-on: ubuntu-latest
    needs: [sync-mbn-channels]
    if: always()
    
    steps:
    - name: Cleanup old workflow runs using API
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "开始清理旧的工作流运行记录..."
        echo "工作流名称: Sync MBN Channels"
        echo "仓库: ${{ github.repository }}"
        
        # 设置要保留的运行数量
        KEEP_COUNT=3
        echo "将保留最近的 $KEEP_COUNT 次运行"
        
        # 获取当前工作流的所有运行记录（使用GitHub API）
        echo "获取运行记录列表..."
        
        # 首先获取工作流ID
        WORKFLOW_NAME="Sync MBN Channels"
        echo "尝试获取工作流ID..."
        
        # 获取工作流ID（通过工作流名称）
        WORKFLOW_INFO=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows")
        
        # 查找对应的工作流ID
        WORKFLOW_ID=$(echo "$WORKFLOW_INFO" | jq -r '.workflows[] | select(.name=="'"$WORKFLOW_NAME"'") | .id')
        
        if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
          echo "无法获取工作流ID，使用默认值"
          # 尝试从环境变量获取
          WORKFLOW_ID="${{ github.workflow_id }}"
        fi
        
        echo "工作流ID: $WORKFLOW_ID"
        
        if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
          echo "❌ 无法获取工作流ID，跳过清理"
          exit 0
        fi
        
        # 获取运行记录
        RUNS_JSON=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/${{ github.repository }}/actions/workflows/$WORKFLOW_ID/runs?per_page=100&status=completed")
        
        # 检查是否获取成功
        if [ -z "$RUNS_JSON" ]; then
          echo "❌ 无法获取运行记录"
          exit 0
        fi
        
        # 提取运行记录ID列表
        RUN_IDS=$(echo "$RUNS_JSON" | jq -r '.workflow_runs[].id' 2>/dev/null || echo "")
        
        if [ -z "$RUN_IDS" ]; then
          echo "没有找到运行记录"
          exit 0
        fi
        
        # 统计运行记录数量
        RUN_COUNT=$(echo "$RUN_IDS" | wc -l)
        echo "找到 $RUN_COUNT 个运行记录"
        
        # 转换为数组
        IFS=$'\n' read -r -d '' -a RUN_ID_ARRAY <<< "$RUN_IDS"
        
        if [ ${#RUN_ID_ARRAY[@]} -le $KEEP_COUNT ]; then
          echo "运行记录数量 (${#RUN_ID_ARRAY[@]}) 小于或等于要保留的数量 ($KEEP_COUNT)，跳过清理"
          exit 0
        fi
        
        echo "将删除 ${#RUN_ID_ARRAY[@]} - $KEEP_COUNT = $(( ${#RUN_ID_ARRAY[@]} - $KEEP_COUNT )) 个旧运行记录"
        
        # 删除旧的运行记录（保留最近的KEEP_COUNT个）
        DELETED_COUNT=0
        for i in "${!RUN_ID_ARRAY[@]}"; do
          if [ $i -ge $KEEP_COUNT ]; then
            RUN_ID="${RUN_ID_ARRAY[$i]}"
            echo "删除运行记录 [$i]: $RUN_ID"
            
            # 删除运行记录
            RESPONSE=$(curl -s -w "%{http_code}" -X DELETE \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs/$RUN_ID" \
              -o /dev/null)
            
            if [ "$RESPONSE" = "204" ]; then
              echo "✅ 成功删除运行记录: $RUN_ID"
              DELETED_COUNT=$((DELETED_COUNT + 1))
            else
              echo "❌ 删除失败 (HTTP $RESPONSE): $RUN_ID"
            fi
            
            # 避免速率限制，添加短暂延迟
            sleep 0.5
          fi
        done
        
        echo "清理完成，删除了 $DELETED_COUNT 个旧运行记录"
