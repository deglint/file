name: Sync MBN Channels

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新MBN频道'

permissions:
  contents: write

jobs:
  sync-mbn-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Fetch KoreaTV JSON data
      run: |
        curl -s -o koreatv.json https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json
        
    - name: Extract MBN URLs
      id: extract-urls
      run: |
        # 提取MBN URL
        MBN_URL=$(jq -r '.[] | select(.name=="MBN") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        # 提取MBN 플러스 URL
        MBN_PLUS_URL=$(jq -r '.[] | select(.name=="MBN 플러스") | (.uris[0] // .url)' koreatv.json 2>/dev/null || echo "")
        
        echo "MBN_URL=$MBN_URL" >> $GITHUB_ENV
        echo "MBN_PLUS_URL=$MBN_PLUS_URL" >> $GITHUB_ENV
        
        echo "MBN URL: $MBN_URL"
        echo "MBN 플러스 URL: $MBN_PLUS_URL"
        
    - name: Debug - Show kr.m3u content
      run: |
        echo "显示kr.m3u文件内容:"
        echo "=========================================="
        grep -A 1 -B 1 "MBN" kr.m3u || echo "未找到MBN相关内容"
        echo "=========================================="
        echo -e "\n显示文件前20行:"
        head -20 kr.m3u
        
    - name: Update MBN channel
      if: env.MBN_URL != '' && env.MBN_URL != 'null'
      run: |
        echo "更新MBN频道链接..."
        echo "MBN URL: $MBN_URL"
        
        # 使用更精确的sed模式
        sed -i 's|\(#EXTINF.*MBN.*\n\)http.*|\1'"$MBN_URL"'|' kr.m3u
        
        echo "更新后检查:"
        grep -A 1 "MBN" kr.m3u
        
    - name: Check if MBN 플러스 exists
      id: check-mbn-plus
      run: |
        echo "检查MBN 플러斯是否存在..."
        if grep -q "MBN 플러스" kr.m3u; then
          echo "找到MBN 플러斯频道"
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "未找到MBN 플러斯频道"
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update or add MBN 플러스 channel
      if: env.MBN_PLUS_URL != '' && env.MBN_PLUS_URL != 'null'
      run: |
        echo "处理MBN 플러斯频道..."
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
        if [[ "${{ steps.check-mbn-plus.outputs.exists }}" == "true" ]]; then
          echo "更新现有的MBN 플러斯频道..."
          # 更新现有的MBN 플러斯频道
          sed -i 's|\(#EXTINF.*MBN 플러스.*\n\)http.*|\1'"$MBN_PLUS_URL"'|' kr.m3u
        else
          echo "添加新的MBN 플러斯频道..."
          
          # 使用Python添加新频道，更可靠
          python3 -c "
import re

# 读取文件
with open('kr.m3u', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 查找MBN频道位置
mbn_found = False
for i, line in enumerate(lines):
    if '#EXTINF' in line and 'MBN' in line and '플러스' not in line:
        mbn_found = True
        # 找到MBN频道，在它后面添加MBN 플러斯
        insert_index = i + 2  # 跳过EXTINF行和URL行
        
        # 构建MBN 플러斯频道条目
        mbn_plus_entry = [
            '#EXTINF:-1 tvg-id="" tvg-name="MBN 플러스" tvg-logo="https://i.postimg.cc/NFxKbbvJ/mbn-plus.png" group-title="韩国",MBN 플러스\n',
            '$MBN_PLUS_URL\n'
        ]
        
        # 插入到正确位置
        lines[i+2:i+2] = mbn_plus_entry
        break

if mbn_found:
    # 写入文件
    with open('kr.m3u', 'w', encoding='utf-8') as f:
        f.writelines(lines)
    print('成功添加MBN 플러斯频道')
else:
    print('错误：未找到MBN频道')
"
        fi
        
        echo "更新后检查MBN 플러斯:"
        grep -A 1 "MBN 플러스" kr.m3u || echo "未找到MBN 플러斯"
        
    - name: Check for changes
      id: check-changes
      run: |
        echo "检查文件变化..."
        git status
        
        # 检查kr.m3u文件是否有变化
        if ! git diff --quiet kr.m3u; then
          echo "检测到变化"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "变化详情:"
          git diff kr.m3u
        else
          echo "没有检测到变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        echo "提交更改..."
        
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add kr.m3u
        git commit -m "自动更新: MBN和MBN 플러斯频道链接 $(date '+%Y-%m-%d %H:%M:%S')"
        
        git push origin main
        
    - name: No changes to commit
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "没有检测到需要提交的更改"
        echo "可能的原因:"
        echo "1. 文件已经是最新状态"
        echo "2. 更新操作失败"
        echo "3. 匹配模式不正确"
        echo ""
        echo "当前URL:"
        echo "MBN URL: ${{ env.MBN_URL }}"
        echo "MBN 플러斯 URL: ${{ env.MBN_PLUS_URL }}"
