name: Sync MBN Channels

on:
  # 定时触发：每2小时运行一次
  schedule:
    - cron: '0 */2 * * *'
  
  # 手动触发
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新MBN频道'
  
  # 当代码推送到main分支时也触发
  push:
    branches: [main]
    paths:
      - '.github/workflows/sync-mbn.yml'
      - 'koreatv.json'

# 设置权限
permissions:
  contents: write

jobs:
  sync-mbn-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: Fetch KoreaTV JSON data
      run: |
        echo "正在获取koreatv.json数据..."
        curl -s -o koreatv.json https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json
        echo "数据获取完成"
        
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        echo "依赖安装完成"
        
    - name: Extract MBN URLs
      id: extract-urls
      run: |
        echo "开始提取URL..."
        
        # 从koreatv.json中提取MBN URL
        MBN_URL=$(jq -r '.[] | select(.name=="MBN") | .url' koreatv.json 2>/dev/null || echo "")
        
        # 从koreatv.json中提取MBN 플러스 URL
        MBN_PLUS_URL=$(jq -r '.[] | select(.name=="MBN 플러스") | .url' koreatv.json 2>/dev/null || echo "")
        
        # 如果MBN_PLUS_URL为空或与MBN_URL相同，尝试其他名称
        if [[ -z "$MBN_PLUS_URL" || "$MBN_PLUS_URL" == "null" || "$MBN_PLUS_URL" == "$MBN_URL" ]]; then
          echo "尝试查找MBN 플러斯备用名称..."
          # 尝试查找其他可能的名称
          MBN_PLUS_URL=$(jq -r '.[] | select(.name | contains("MBN+") or contains("MBN 플러스") or contains("MBN플러스") or contains("MBN Plus")) | .url' koreatv.json 2>/dev/null || echo "")
        fi
        
        # 如果仍然为空，则使用MBN_URL作为基础
        if [[ -z "$MBN_PLUS_URL" || "$MBN_PLUS_URL" == "null" ]]; then
          echo "未找到MBN 플러斯专用链接，将使用修改后的MBN链接"
          # 修改MBN URL作为MBN 플러斯链接
          if [[ -n "$MBN_URL" && "$MBN_URL" != "null" ]]; then
            # 尝试修改URL中的参数来创建不同的链接
            MBN_PLUS_URL="${MBN_URL}"
            # 添加后缀参数使其不同
            MBN_PLUS_URL="${MBN_PLUS_URL}&ch=mbnplus"
          fi
        fi
        
        # 确保两个URL不同
        if [[ "$MBN_URL" == "$MBN_PLUS_URL" && -n "$MBN_URL" ]]; then
          echo "URL相同，为MBN 플러斯添加不同参数..."
          if [[ "$MBN_PLUS_URL" == *"?"* ]]; then
            MBN_PLUS_URL="${MBN_PLUS_URL}&platform=plus"
          else
            MBN_PLUS_URL="${MBN_PLUS_URL}?platform=plus"
          fi
        fi
        
        # 输出到环境变量
        echo "MBN_URL=$MBN_URL" >> $GITHUB_ENV
        echo "MBN_PLUS_URL=$MBN_PLUS_URL" >> $GITHUB_ENV
        
        # 输出到步骤输出
        echo "::set-output name=mbn_url::$MBN_URL"
        echo "::set-output name=mbn_plus_url::$MBN_PLUS_URL"
        
        echo "提取结果："
        echo "MBN URL: $MBN_URL"
        echo "MBN 플러斯 URL: $MBN_PLUS_URL"
        
    - name: Update kr.m3u file
      run: |
        echo "开始更新kr.m3u文件..."
        
        if [ ! -f "kr.m3u" ]; then
          echo "错误：kr.m3u文件不存在"
          exit 1
        fi
        
        # 备份原文件
        cp kr.m3u kr.m3u.backup
        
        # 检查并更新MBN频道
        if [[ -n "$MBN_URL" && "$MBN_URL" != "null" ]]; then
          echo "更新MBN频道链接..."
          
          # 使用Python脚本来更可靠地更新M3U文件
          python3 -c "
import sys

# 读取文件
with open('kr.m3u', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# 更新MBN频道
in_mbn_section = False
updated_mbn = False
for i, line in enumerate(lines):
    if '#EXTINF' in line and ('tvg-name=\"MBN\"' in line or ',MBN' in line):
        in_mbn_section = True
        # 下一行应该是URL
        if i+1 < len(lines) and lines[i+1].startswith('http'):
            lines[i+1] = '$MBN_URL' + '\n'
            updated_mbn = True
            in_mbn_section = False

if not updated_mbn:
    print('警告：未找到MBN频道进行更新')

# 更新MBN 플러斯频道
in_mbn_plus_section = False
updated_mbn_plus = False
mbn_plus_found = False

for i, line in enumerate(lines):
    if '#EXTINF' in line and ('MBN 플러스' in line or 'MBN플러스' in line or 'MBN Plus' in line):
        mbn_plus_found = True
        in_mbn_plus_section = True
        # 下一行应该是URL
        if i+1 < len(lines) and lines[i+1].startswith('http'):
            lines[i+1] = '$MBN_PLUS_URL' + '\n'
            updated_mbn_plus = True
            in_mbn_plus_section = False

# 如果未找到MBN 플러斯频道，在MBN后添加
if not mbn_plus_found and '$MBN_PLUS_URL' and '$MBN_PLUS_URL' != 'null':
    print('添加新的MBN 플러斯频道...')
    # 查找MBN频道位置
    for i, line in enumerate(lines):
        if '#EXTINF' in line and ('tvg-name=\"MBN\"' in line or ',MBN' in line):
            # 确保MBN频道后有URL行
            if i+1 < len(lines) and lines[i+1].startswith('http'):
                # 在MBN频道后插入MBN 플러斯
                mbn_plus_entry = ['#EXTINF:-1 tvg-id=\"\" tvg-name=\"MBN 플러스\" tvg-logo=\"https://i.postimg.cc/NFxKbbvJ/mbn-plus.png\" group-title=\"韩国\",MBN 플러스\n', '$MBN_PLUS_URL\n']
                lines[i+2:i+2] = mbn_plus_entry
                updated_mbn_plus = True
                break

# 写入文件
with open('kr.m3u', 'w', encoding='utf-8') as f:
    f.writelines(lines)

print('文件更新完成')
print(f'MBN URL: $MBN_URL')
print(f'MBN 플러斯 URL: $MBN_PLUS_URL')
"
        else
          echo "警告：未找到有效的MBN URL"
        fi
        
        # 检查是否有变化
        if cmp -s kr.m3u kr.m3u.backup; then
          echo "没有检测到变化"
          echo "NO_CHANGES=true" >> $GITHUB_ENV
        else
          echo "检测到变化"
          echo "NO_CHANGES=false" >> $GITHUB_ENV
          echo "变化内容："
          diff -u kr.m3u.backup kr.m3u | head -20
        fi
        
    - name: Commit and push changes
      if: env.NO_CHANGES == 'false'
      run: |
        echo "提交更改..."
        
        # 配置Git
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        # 添加文件
        git add kr.m3u
        
        # 检查是否有更改
        if git diff --cached --quiet; then
          echo "没有更改可提交"
          echo "NO_COMMIT=true" >> $GITHUB_ENV
        else
          echo "有更改可提交"
          # 提交更改
          git commit -m "自动更新: MBN和MBN 플러斯频道链接 $(date '+%Y-%m-%d %H:%M:%S')
          
          更新内容:
          - MBN: ${{ env.MBN_URL }}
          - MBN 플러斯: ${{ env.MBN_PLUS_URL }}"
          
          # 推送到仓库
          git push origin HEAD:main
          
          echo "更改已提交并推送"
        fi
        
    - name: No changes to commit
      if: env.NO_CHANGES == 'true' || env.NO_COMMIT == 'true'
      run: |
        echo "没有检测到需要提交的更改"
        echo "工作流完成"
