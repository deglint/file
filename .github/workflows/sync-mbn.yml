name: Sync MBN Channels

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: '手动触发的理由'
        required: false
        default: '手动更新MBN频道'

permissions:
  contents: write

jobs:
  sync-mbn-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl
        
    - name: Fetch KoreaTV JSON data
      run: |
        curl -s -o koreatv.json https://raw.githubusercontent.com/kenpark76/kenpark76.github.io/refs/heads/main/koreatv.json
        echo "显示koreatv.json前200个字符:"
        head -c 200 koreatv.json
        echo -e "\n\n显示所有频道名称:"
        jq -r '.[].name' koreatv.json || echo "无法解析JSON"
        
    - name: Extract MBN URLs
      id: extract-urls
      run: |
        # 显示JSON结构，帮助我们调试
        echo "显示JSON结构前几行:"
        jq '.' koreatv.json | head -50
        
        echo -e "\n\n显示所有包含'MBN'的频道:"
        jq -r '.[] | select(.name | contains("MBN")) | "名称: \(.name), URL: \(.url)"' koreatv.json
        
        # 提取MBN URL
        MBN_URL=$(jq -r '.[] | select(.name=="MBN") | .url' koreatv.json 2>/dev/null || echo "")
        echo "MBN URL提取结果: $MBN_URL"
        
        # 尝试多种方式提取MBN 플러스 URL
        echo -e "\n尝试不同方式提取MBN 플러斯URL..."
        
        # 方式1: 精确匹配
        MBN_PLUS_URL=$(jq -r '.[] | select(.name=="MBN 플러스") | .url' koreatv.json 2>/dev/null || echo "")
        echo "精确匹配结果: $MBN_PLUS_URL"
        
        # 方式2: 包含"MBN 플러斯"
        if [[ -z "$MBN_PLUS_URL" || "$MBN_PLUS_URL" == "null" ]]; then
          MBN_PLUS_URL=$(jq -r '.[] | select(.name | contains("MBN 플러스")) | .url' koreatv.json 2>/dev/null || echo "")
          echo "包含匹配结果: $MBN_PLUS_URL"
        fi
        
        # 方式3: 查找可能的MBN 플러斯频道
        if [[ -z "$MBN_PLUS_URL" || "$MBN_PLUS_URL" == "null" ]]; then
          # 查找所有名称包含MBN但不只是MBN的频道
          MBN_PLUS_URL=$(jq -r '.[] | select(.name | contains("MBN") and (.name != "MBN")) | .url' koreatv.json 2>/dev/null | head -1 || echo "")
          echo "其他MBN频道结果: $MBN_PLUS_URL"
        fi
        
        # 如果仍然为空，则使用已知的链接
        if [[ -z "$MBN_PLUS_URL" || "$MBN_PLUS_URL" == "null" ]]; then
          echo "从JSON中未找到MBN 플러斯链接，使用备用链接..."
          # 根据你提供的koreatv.json第177行，使用这个链接
          MBN_PLUS_URL="https://youtu.be/5_J8nQSoQj8"
        fi
        
        echo "MBN_URL=$MBN_URL" >> $GITHUB_ENV
        echo "MBN_PLUS_URL=$MBN_PLUS_URL" >> $GITHUB_ENV
        
        echo -e "\n最终结果:"
        echo "MBN URL: $MBN_URL"
        echo "MBN 플러스 URL: $MBN_PLUS_URL"
        
    - name: Update MBN channel
      if: env.MBN_URL != ''
      run: |
        echo "更新MBN频道链接..."
        sed -i '/#EXTINF.*tvg-name="MBN"/,+1s|^http.*$|'"$MBN_URL"'|' kr.m3u
        
    - name: Check if MBN 플러스 exists
      id: check-mbn-plus
      run: |
        if grep -q "MBN 플러스" kr.m3u; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Update existing MBN 플러스 channel
      if: steps.check-mbn-plus.outputs.exists == 'true' && env.MBN_PLUS_URL != ''
      run: |
        echo "更新现有的MBN 플러斯频道链接..."
        sed -i '/#EXTINF.*MBN 플러스/,+1s|^http.*$|'"$MBN_PLUS_URL"'|' kr.m3u
        
    - name: Add new MBN 플러스 channel
      if: steps.check-mbn-plus.outputs.exists == 'false' && env.MBN_PLUS_URL != ''
      run: |
        echo "添加新的MBN 플러斯频道..."
        
        # 查找MBN频道位置
        MBN_LINE=$(grep -n '#EXTINF.*tvg-name="MBN"' kr.m3u | head -1 | cut -d: -f1)
        
        if [ -n "$MBN_LINE" ]; then
          # MBN频道的URL行
          URL_LINE=$((MBN_LINE + 1))
          
          # 创建临时文件
          cat > temp.m3u << EOF
$(head -n "$URL_LINE" kr.m3u)
#EXTINF:-1 tvg-id="" tvg-name="MBN 플러스" tvg-logo="https://i.postimg.cc/NFxKbbvJ/mbn-plus.png" group-title="韩国",MBN 플러스
$MBN_PLUS_URL
$(tail -n +$((URL_LINE + 1)) kr.m3u)
EOF
          
          mv temp.m3u kr.m3u
          echo "成功添加MBN 플러斯频道"
        else
          echo "错误：未找到MBN频道"
        fi
        
    - name: Check for changes
      id: check-changes
      run: |
        if git diff --quiet kr.m3u; then
          echo "没有检测到变化"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "检测到变化"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "变化详情:"
          git diff kr.m3u
        fi
        
    - name: Commit and push changes
      if: steps.check-changes.outputs.has_changes == 'true'
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
        git add kr.m3u
        git commit -m "自动更新: MBN和MBN 플러斯频道链接 $(date '+%Y-%m-%d %H:%M:%S')"
        
        git push origin main
        
    - name: No changes to commit
      if: steps.check-changes.outputs.has_changes == 'false'
      run: |
        echo "没有检测到需要提交的更改"
        echo "MBN URL: ${{ env.MBN_URL }}"
        echo "MBN 플러斯 URL: ${{ env.MBN_PLUS_URL }}"
